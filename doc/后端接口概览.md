# 后端接口概览

+ 本文档主要描述后端为前端提供哪些接口及其数据格式；
+ 如没有特殊说明，返回的 status 均为 0 表示成功，非零表示失败；
+ 最后更新时间 2019/6/6

---

## User

| 进度  | 接口名称            | 输入参数                                                                 | 输出参数                                                                                                          | 备注                                                                                      |
| :---: | :------------------ | :----------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------- |
|   √   | register            | email, pswd_hash, user_name, gender, resident_city_id                    | user_id, status                                                                                                   | comment 和 avatar_url 自动置为空串, city_id=1对应于未设置, gender in ['M', 'F', 'U', 'O'] |
|   √   | login               | email, pswd_hash                                                         | user_id, session_id, status                                                                                       | pswd_hash 是32位 char                                                                     |
|   √   | logout              | user_id, session_id                                                      | status                                                                                                            |                                                                                           |
|   √   | reset_password      | user_id, session_id, old_pswd_hash, new_pswd_hash                        | status                                                                                                            |                                                                                           |
|   √   | get_user_info       | user_id, session_id                                                      | user_name, email, gender, resident_city_id, resident_city: {city_id, city_name, ...}, comment, avatar_url, status | comment 是个性化签名                                                                      |
|   √   | set_user_info       | user_id, session_id, user_name, email, gender, resident_city_id, comment | status                                                                                                            |                                                                                           |
|   √   | set_user_avatar_url | user_id, session_id, avatar_url                                          | status                                                                                                            |                                                                                           |
+ 注：用户每次操作后台会更新用户的 `last_action_time`，若用户连续10分钟无操作，即前端连续10分钟未访问除 city 外的 api，则后台自动删除用户 session，若10分钟后再次访问接口则会 raise UserSessionTimeoutException

---

## Travel Group

| 进度  | 接口名称                     | 输入参数                                                                                       | 输出参数                                                                                                                                                    | 备注                                                                      |
| :---: | :--------------------------- | :--------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------ |
|   √   | add_travel_group             | user_id, session_id, travel_group_name, travel_group_note, travel_group_color                  | travel_group_id, status                                                                                                                                     |                                                                           |
|   √   | remove_travel_group          | user_id, session_id, travel_group_id                                                           | status                                                                                                                                                      | 一并删除 travel group 内的所有 travel, 删除每个 travel 会自动通知关联好友 |
|   √   | get_travel_group_list        | user_id, session_id                                                                            | count, [travel_group_list], status                                                                                                                          | travel_group_list 内含 travel_group_id                                    |
|   √   | get_all_travel_group_details | user_id, session_id                                                                            | count, [travel_group_info_list: {owner_user_id, travel_group_name, travel_group_note, travel_group_color, travel_infos: {count, travel_info_list}}], status | color 是 7 位 char (#FFFFFF)                                              |
|   √   | get_travel_group_info_list   | user_id, session_id                                                                            | count, [travel_group_info_list: {owner_user_id, travel_group_name, travel_group_note, travel_group_color}], status                                          | color 是 7 位 char (#FFFFFF)                                              |
|   √   | get_travel_group_details     | user_id, session_id, travel_group_id                                                           | owner_user_id, travel_group_name, travel_group_note, travel_group_color, travel_infos: {count, travel_info_list}, status                                    | color 是 7 位 char (#FFFFFF)                                              |
|   √   | get_travel_group_info        | user_id, session_id, travel_group_id                                                           | owner_user_id, travel_group_name, travel_group_note, travel_group_color, status                                                                             | color 是 7 位 char (#FFFFFF)                                              |
|   √   | set_travel_group_info        | user_id, session_id, travel_group_id, travel_group_name, travel_group_note, travel_group_color | status                                                                                                                                                      |                                                                           |
|   √   | get_travel_list              | user_id, session_id, travel_group_id                                                           | count, [travel_list], status                                                                                                                                | travel_list 内含 travel_id                                                |
|   √   | get_travel_info_list         | user_id, session_id, travel_group_id                                                           | count, [travel_info_list: {travel_id, city_id, city: {city_id, city_name, ...}, date_start, date_end, visibility, travel_note}], status                     |                                                                           |

---

## Travel

| 进度  | 接口名称        | 输入参数                                                                                     | 输出参数                                                                                                       | 备注                                                                                                                                                                                                                     |
| :---: | :-------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|   √   | add_travel      | user_id, session_id, travel_group_id, city_id, date_start, date_end, visibility, travel_note | travel_id, status                                                                                              |                                                                                                                                                                                                                          |
|   √   | copy_travel     | user_id, session_id, travel_group_id, source_travel_id, add_association                      | new_travel_id, status                                                                                          | 复制 src_travel 除关联用户外的所有设置并加入自己的 travel_group，若 user 已关联 travel 且 add_association 为真，则自动将 travel 的所有者加入 new_travel，travel 的所有者可以为任意用户（自己好友陌生人）但必须有权限访问 |
|   √   | remove_travel   | user_id, session_id, travel_group_id, travel_id                                              | status                                                                                                         | 删除 travel 会自动通知关联好友                                                                                                                                                                                           |
|   √   | move_travel     | user_id, session_id, travel_group_id, travel_id, other_travel_group_id                       | status                                                                                                         |                                                                                                                                                                                                                          |
|   √   | get_travel_info | user_id, session_id, travel_id                                                               | owner_user_id, city_id, city: {city_id, city_name, ...}, date_start, date_end, visibility, travel_note, status | date 格式 "yyyy-mm-dd"                                                                                                                                                                                                   |
|   √   | set_travel_info | user_id, session_id, travel_id, city_id, date_start, date_end, visibility, travel_note       | status                                                                                                         | 修改 travel 会自动通知关联好友                                                                                                                                                                                           |

---

## Travel Association

| 进度  | 接口名称                        | 输入参数                                              | 输出参数                          | 备注                                                      |
| :---: | :------------------------------ | :---------------------------------------------------- | :-------------------------------- | :-------------------------------------------------------- |
|   √   | invite_travel_company           | user_id, session_id, travel_id, friend_user_id        | status                            | 向好友发送邀请请求                                        |
|   √   | join_friends_travel             | user_id, session_id, friend_user_id, friend_travel_id | status                            | 加入好友的旅行                                            |
|   √   | remove_travel_company           | user_id, session_id, travel_id, friend_user_id        | status                            | 删除关联好友                                              |
|   √   | leave_friends_travel            | user_id, session_id, friend_user_id, friend_travel_id | status                            | 离开好友的旅行                                            |
|   √   | get_travel_company_list         | user_id, session_id, travel_id                        | count, [company_list], status     | company_list 内含好友 user_id                             |
|   √   | get_associated_travel_list      | user_id, session_id                                   | count, [travel_list], status      | 返回所有关联了 user_id 的旅行, travel_list 内含 travel_id |
|   √   | get_associated_travel_info_list | user_id, session_id                                   | count, [travel_info_list], status |                                                           |

---

## Friend

| 进度  | 接口名称                            | 输入参数                                          | 输出参数                                                                                                                                                                 | 备注                                                                                                                                            |
| :---: | :---------------------------------- | :------------------------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
|   √   | get_others_user_info                | user_id, session_id, others_user_id               | user_id, user_name, (friend_note,) gender, resident_city_id, resident_city: {city_id, city_name, ...}, avatar_url, comment, is_friend, status                            | status = 成功 or 用户不存在                                                                                                                     |
|   √   | get_others_user_info_list           | user_id, session_id, other_user_list              | count, [user_info_list: {user_id, user_name, (friend_note,) gender, resident_city_id, resident_city: {city_id, city_name, ...}, avatar_url, comment, is_friend}], status | status = 成功 or 用户不存在                                                                                                                     |
|   √   | search_user_by_email                | user_id, session_id, query_email                  | user_id, status                                                                                                                                                          | status = 成功 or 用户不存在                                                                                                                     |
|   √   | search_user_list_by_user_name       | user_id, session_id, query_user_name              | count, [user_list], status                                                                                                                                               | user_list 内含 user_id                                                                                                                          |
|   √   | search_user_info_by_email           | user_id, session_id, query_email                  | user_id, user_name, (friend_note,) gender, resident_city_id, resident_city: {city_id, city_name, ...}, avatar_url, comment, is_friend, status                            | status = 成功 or 用户不存在                                                                                                                     |
|   √   | search_user_info_list_by_user_name  | user_id, session_id, query_user_name              | count, [user_info_list], status                                                                                                                                          | user_info_list 内含 user_info (不含 friend_note, is_friend)                                                                                     |
|   √   | send_friend_request                 | user_id, session_id, others_user_id, request_note | status                                                                                                                                                                   | status = 成功发送请求 or 用户不存在 or 已是好友                                                                                                 |
|   √   | add_friend                          | user_id, session_id, friend_user_id, friend_note  | status                                                                                                                                                                   | friend_note 如果为空串则后端自动设为 friend_user_name, status = 成功添加 or 用户不存在 or 已是好友                                              |
|   √   | remove_friend                       | user_id, session_id, friend_user_id               | status                                                                                                                                                                   | 删除会自动删除双方 travel 的关联                                                                                                                |
|   √   | get_friend_list                     | user_id, session_id                               | count, [friend_list], status                                                                                                                                             | friend_list 内含好友 user_id                                                                                                                    |
|   √   | get_friend_user_info                | user_id, session_id, friend_user_id               | user_id, user_name, gender, resident_city_id, resident_city: {city_id, city_name, ...}, comment, avatar_url, friend_note, status                                         |                                                                                                                                                 |
|   √   | set_friend_note                     | user_id, session_id, friend_user_id, friend_note  | status                                                                                                                                                                   | friend_note 如果为空串则后端自动设为 friend_user_name                                                                                           |
|   √   | get_others_all_travel_group_details | user_id, session_id                               | count, [travel_group_info_list: {owner_user_id, travel_group_name, travel_group_note, travel_group_color, travel_infos: {count, travel_info_list}}], status              | color 是 7 位 char (#FFFFFF)                                                                                                                    |
|   √   | get_others_travel_group_list        | user_id, session_id, other_user_id                | count, [travel_group_list], status                                                                                                                                       | 只返回内部有可见 travel 的 travel group, travel_group_list 内含 travel_group_id                                                                 |
|   √   | get_others_travel_group_info_list   | user_id, session_id, other_user_id                | count, [travel_group_info_list: {travel_group_id, owner_user_id, ...}], status                                                                                           | 只返回内部有可见 travel 的 travel group                                                                                                         |
|   √   | get_travel_group_details            | user_id, session_id, travel_group_id              | 输出同原始的 get_travel_group_details 方法                                                                                                                               | 调用方法和自己的一样，只是 travel_group_id 可以不是自己的，后端已做权限处理，非自己的行程只读。自动返回可见范围的信息，若无法看到则返回错误代码 |
|   √   | get_travel_..._info                 | user_id, session_id, travel_..._id                | 输出同原始的 get_travel_..._info 方法                                                                                                                                    | 调用方法和自己的一样，只是 travel_..._id 可以不是自己的，后端已做权限处理，非自己的行程只读。自动返回可见范围的信息，若无法看到则返回错误代码   |
|   √   | get_travel_..._info_list            | user_id, session_id, travel_..._id                | 输出同原始的 get_travel_..._info_list 方法                                                                                                                               | 调用方法和自己的一样，只是 travel_..._id 可以不是自己的，后端已做权限处理，非自己的行程只读。自动返回可见范围的信息，若无法看到则返回错误代码   |
|   √   | get_travel_list                     | user_id, session_id, travel_group                 | count, [travel_list], status                                                                                                                                             | 调用方法同上，自动返回可见范围的信息，若无法看到则返回空列表, travel_list 内含 travel_id                                                        |

---

## Recommendation

| 进度  | 接口名称                              | 输入参数                             | 输出参数                                                                                           | 备注 |
| :---: | :------------------------------------ | :----------------------------------- | :------------------------------------------------------------------------------------------------- | :--- |
|   √   | recommend_friend_list                 | user_id, session_id                  | count, [user_list], status                                                                         |
|   √   | recommend_travel_group_list           | user_id, session_id                  | count, [travel_group_list], status                                                                 |
|   √   | recommend_city_list_by_travel         | user_id, session_id, travel_id       | count, [city_list: {city_id, country_name, province_name, city_name, latitude, longitude}], status |      |
|   √   | recommend_city_list_by_travel_group   | user_id, session_id, travel_group_id | count, [city_list: {city_id, country_name, province_name, city_name, latitude, longitude}], status |      |
|   √   | recommend_travel_list_by_travel       | user_id, session_id, travel_id       | count, [travel_list], status                                                                       |      |
|   √   | recommend_travel_list_by_travel_group | user_id, session_id, travel_group_id | count, [travel_list], status                                                                       |      |

---

## Message

| 进度  | 接口名称            | 输入参数                    | 输出参数                                                                                              | 备注                                                                                                                                    |
| :---: | :------------------ | :-------------------------- | :---------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
|   √   | get_friend_msg_list | user_id, session_id         | count, [friend_msg_list: {msg_id, user_id, friend_user_id, msg_type, msg_content}], status            | 返回用户所有的好友消息（加好友/删好友）, msg_type in ['A', 'D']                                                                         |
|   √   | del_friend_msg      | user_id, session_id, msg_id | status                                                                                                | 删除用户处理过的好友消息，如果同意添加好友则需同时调用 add_friend                                                                       |
|   √   | get_travel_msg_list | user_id, session_id         | count, [travel_msg_list: {msg_id, user_id, friend_user_id, travel_id, msg_type, msg_content}], status | 返回用户所有的行程关联消息（邀请加入行程/加入行程/删除关联/主动离开行程/修改行程/删除行程）, msg_type in ['I', 'A', 'R', 'L', 'M', 'D'] |
|   √   | del_travel_msg      | user_id, session_id, msg_id | status                                                                                                | 删除用户处理过的行程关联消息，如果同意加入好友的旅行则需同时调用 join_friends_travel                                                    |

---

## City

| 进度  | 接口名称             | 输入参数            | 输出参数                                                                                           | 备注                                                                      |
| :---: | :------------------- | :------------------ | :------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------ |
|   √   | address_to_city      | address             | city_id, country_name, province_name, city_name, latitude, longitude, status                       | address 是模糊地址字符串，交由 API 处理，返回第一个结果，如果不存在则报错 |
|   √   | address_to_city_list | address             | count, [city_list: {city_id, country_name, province_name, city_name, latitude, longitude}], status | address 是模糊地址字符串，交由 API 处理，返回列表可能为空                 |
|   √   | gps_to_city          | latitude, longitude | city_id, country_name, province_name, city_name, latitude, longitude, status                       | 如果不存在则报错                                                          |
|   √   | city_id_to_city      | city_id             | status, country_name, province_name, city_name, latitude, longitude                                | 如果不存在则报错                                                          |

+ 注：保留国家信息，方便前端区分
