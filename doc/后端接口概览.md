# 后端接口概览

+ 本文档主要描述后端为前端提供哪些接口及其数据格式；
+ 如没有特殊说明，返回的 status 均为 0 表示成功，非零表示失败；
+ 最后更新时间 2019/5/23，当前版本号 v0.4，暂未完成。

---

## 用户相关接口

| 进度  | 接口名称           | 输入参数                                                     | 输出参数                                                                               | 备注                                                              |
| :---: | :----------------- | :----------------------------------------------------------- | :------------------------------------------------------------------------------------- | :---------------------------------------------------------------- |
|   √   | register           | email, pswd_hash, user_name, gender, resident_city_id        | user_id, status                                                                        | status = 存在 or 注册成功, comment 自动置为空串                   |
|   √   | login              | email, pswd_hash                                             | user_id, session_id, status                                                            | pswd_hash 是32位 char                                             |
|   √   | logout             | user_id, session_id                                          | status                                                                                 |                                                                   |
|   √   | get_user_info      | user_id, session_id                                          | user_name, email, gender, resident_city_id, comment, status                            | comment 是个性化签名                                              |
|   √   | set_user_info      | user_id, user_name, email, gender, comment, resident_city_id | status                                                                                 |                                                                   |
|   √   | reset_password     | user_id, session_id, old_pswd_hash, new_pswd_hash            | status                                                                                 |                                                                   |
|   ×   | get_friend_msg     | user_id, session_id                                          | count, [friend_msg_id, friend_user_id, msg_type, msg_content], status                  | 返回用户所有的好友消息（加好友/删好友）                           |
|   ×   | respond_friend_msg | user_id, session_id, friend_msg_id                           |                                                                                        | 删除用户处理过的好友消息                                          |
|   ×   | get_travel_msg     | user_id, session_id                                          | count, [travel_msg_id, friend_user_id,friend_travel_id, msg_type, msg_content], status | 返回用户所有的行程关联消息（加入行程/离开行程/修改行程/删除行程） |
|   ×   | respond_travel_msg | user_id, session_id, travel_msg_id                           |                                                                                        | 删除用户处理过的行程关联消息                                      |
+ 注：用户每次操作后台会更新用户的 `last_action_time`，若用户连续10分钟无操作，即前端连续10分钟未访问除 city 外的 api，则后台自动删除用户 session，若10分钟后再次访问接口则会 raise UserSessionTimeoutException

---

## 旅行相关接口

| 进度  | 接口名称                | 输入参数                                                                               | 输出参数                                                                     | 备注                          |
| :---: | :---------------------- | :------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------- | :---------------------------- |
|   √   | get_travel_group_list   | user_id, session_id                                                                    | count, [travel_group_id], status                                             |                               |
|   √   | get_travel_list         | user_id, session_id, travel_group_id                                                   | count, [travel_id], status                                                   |                               |
|   ×   | get_related_travel_list | user_id, session_id                                                                    | count, [travel_id], status                                                   | 返回所有关联了 user_id 的旅行 |
|   √   | get_travel_group_info   | user_id, session_id, travel_group_id                                                   | travel_group_name, travel_group_note, travel_group_color, visibility, status | color 是6位 char              |
|   √   | set_travel_group_info   | user_id, session_id, travel_group_id, travel_group_note                                | status                                                                       |                               |
|   √   | add_travel_group        | user_id, session_id                                                                    | travel_group_id, status                                                      |                               |
|   √   | remove_travel_group     | user_id, session_id, travel_group_id                                                   | status                                                                       |                               |
|   √   | get_travel_info         | user_id, session_id, travel_id                                                         | city_id, date_start, date_end, visibility, travel_note, status               | date 格式 "yyyy-mm-dd"        |
|   √   | set_travel_info         | user_id, session_id, travel_id, city_id, date_start, date_end, visibility, travel_note | status                                                                       |
|   √   | add_travel              | user_id, session_id, travel_group_id                                                   | travel_id, status                                                            |                               |
|   √   | remove_travel           | user_id, session_id, travel_group_id, travel_id                                        | status                                                                       |                               |
|   ×   | add_travel_company      | user_id, session_id, travel_id, friend_user_id                                         | status                                                                       |                               |
|   ×   | get_travel_company_list | user_id, session_id, travel_id                                                         | count, [friend_user_id], status                                              |                               |
|   ×   | remove_travel_company   | user_id, session_id, travel_id, friend_user_id                                         | status                                                                       |                               |
+ 注：这里的接口设计逻辑是只允许添加空的 travel_group 和空的 travel，返回一个有效的 travel_group_id 和 travel_id，再进行设置参数

---

## 城市相关接口

| 进度  | 接口名称             | 输入参数            | 输出参数                                                                     | 备注                                    |
| :---: | :------------------- | :------------------ | :--------------------------------------------------------------------------- | :-------------------------------------- |
|   √   | gps_to_city          | latitude, longitude | city_id, country_name, province_name, city_name, latitude, longitude, status |                                         |
|   ×   | address_to_city_list | address             | count, [city_id], status                                                     | address 是模糊地址字符串，交由 API 处理 |
|   √   | city_id_to_city      | city_id             | status, country_name, province_name, city_name, latitude, longitude          | a                                       |
+ 注：保留国家信息，方便前端区分


---

## 好友相关接口

| 进度  | 接口名称                     | 输入参数                                                     | 输出参数                                                                        | 备注                                                                                                                                          |
| :---: | :--------------------------- | :----------------------------------------------------------- | :------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------- |
|   ×   | get_friend_list              | user_id, session_id                                          | count, [friend_user_id], status                                                 |                                                                                                                                               |
|   ×   | get_user_list_by_email       | user_id, session_id, query_email                             | count, [user_id], status                                                        |                                                                                                                                               |
|   ×   | get_user_list_by_user_name   | user_id, session_id, query_user_name                         | count, [user_id], status                                                        |                                                                                                                                               |
|   ×   | add_friend                   | user_id, session_id, friend_user_id, apply_note, friend_note | status                                                                          | status= 成功发送请求 or 用户不存在 or 已是好友                                                                                                |
|   ×   | remove_friend                | user_id, session_id, friend_user_id                          | status                                                                          |                                                                                                                                               |
|   √   | set_friend_note              | user_id, session_id, friend_user_id, friend_note             | status                                                                          | friend_note 如果为空串则后端自动设为 friend_user_name                                                                                         |
|   ×   | get_other_user_info          | user_id, session_id, other_user_id                           | user_id, user_name, email, gender, resident_city_id, comment, is_friend, status |                                                                                                                                               |
|   √   | get_others_travel_group_list | user_id, session_id, other_user_id                           | count, [travel_group_id], status                                                |
|   √   | get_travel_..._info          | user_id, session_id, travel_..._id                           | 输出同原始的 get_travel_..._info 方法                                           | 调用方法和自己的一样，只是 travel_..._id 可以不是自己的，后端已做权限处理，非自己的行程只读。自动返回可见范围的信息，若无法看到则返回错误代码 |
|   √   | get_travel_list              | user_id, session_id, travel_group                            | count, [travel_id], status                                                      | 调用方法同上，自动返回可见范围的信息，若无法看到则返回空列表                                                                                  |
+ 注：get_user_id 设计给搜索添加好友时使用;有 user_id 后查看好友行程列表等功能也可以实现。

---

## 推荐系统接口
| 进度  | 接口名称                            | 输入参数                             | 输出参数                   | 备注                                     |
| :---: | :---------------------------------- | :----------------------------------- | :------------------------- | :--------------------------------------- |
|   ×   | copy_friend_travel                  | user_id, session_id, travel_id       | new_travel_id, status      | travel_id 所有者若不是好友则返回错误代码 |
|   ×   | recommend_friend_list               | user_id, session_id                  | count, [friend_id], status |
|   ×   | recommend_city_list_by_travel       | user_id, session_id, travel_id       | count, [city_id], status   |                                          |
|   ×   | recommend_city_list_by_travel_group | user_id, session_id, travel_group_id | count, [city_id], status   |                                          |
|   ×   | recommend_travel_list_by_travel     | user_id, session_id, travel_id       | count, [travel_id], status |                                          |
|   ×   | recommend_travel_by_travel_group    | user_id, session_id, travel_group_id | count, [travel_id], status |                                          |
